name: Android Remote

on: 
  workflow_dispatch:
 
jobs:
  android:
    runs-on: ubuntu-22.04
    timeout-minutes: 350
    
    steps:
      - name: Setup Environment
        run: |
          sudo apt update -y
          sudo apt install wget qemu-kvm websockify novnc tigervnc-standalone-server curl -y

      - name: Install and Setup Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --accept-routes --ssh --accept-dns
          sleep 10
          echo "ðŸ”— Tailscale IP: $(tailscale ip -4)"

      - name: Download Android
        run: |
          sudo aria2c -s16 -x16 -o android.iso "https://www.fosshub.com/Android-x86.html?dwl=android-x86_64-9.0-r2-k49.iso#"

      - name: Create Virtual Disk
        run: |
          sudo mkdir -p /mnt
          sudo qemu-img create -f qcow2 /mnt/android.qcow2 20G

      - name: Fix VNC Configuration
        run: |
          # Sá»­a file xstartup Ä‘Æ¡n giáº£n hÆ¡n
          sudo mkdir -p /root/.vnc
          sudo cat > /root/.vnc/xstartup << 'EOF'
#!/bin/bash
export XKL_XMODMAP_DISABLE=1
export XDG_CURRENT_DESKTOP="LXDE"
export XDG_MENU_PREFIX="lxde-"
exec startlxde &
EOF
          sudo chmod +x /root/.vnc/xstartup
          
          # Khá»Ÿi Ä‘á»™ng VNC vá»›i cáº¥u hÃ¬nh Ä‘Æ¡n giáº£n
          sudo vncserver -geometry 1024x768 -depth 24 -SecurityTypes None :1
          sleep 5

      - name: Start NoVNC
        run: |
          websockify --web /usr/share/novnc/ 6080 localhost:5901 &
          sleep 3
          echo "âœ… VNC services started"

      - name: Start Android VM
        run: |
          echo "ðŸš€ Starting Android VM..."
          sudo qemu-system-x86_64 \
            -machine q35 \
            -m 3G \
            -cpu host \
            -smp cores=2 \
            -drive file=/mnt/android.qcow2,if=virtio,format=qcow2 \
            -cdrom android.iso \
            -device virtio-vga \
            -vnc :1 \
            -usb \
            -device usb-tablet \
            -netdev user,id=net0,hostfwd=tcp::5555-:5555 \
            -device virtio-net-pci,netdev=net0 \
            -accel kvm \
            -boot d &
          
          echo "â³ Waiting for Android to boot... (120 seconds)"
          sleep 120

      - name: Display Connection Info
        run: |
          TAILSCALE_IP=$(tailscale ip -4)
          echo " "
          echo "ðŸŽ‰ ANDROID REMOTE READY!"
          echo "========================"
          echo "ðŸŒ REMOTE ACCESS:"
          echo "Web VNC: http://$TAILSCALE_IP:6080/vnc.html"
          echo "VNC Direct: $TAILSCALE_IP:5901"
          echo "ADB: $TAILSCALE_IP:5555"
          echo " "
          echo "ðŸ”§ LOCAL ACCESS:"
          echo "Web VNC: http://localhost:6080/vnc.html"
          echo " "
          echo "ðŸ“± Boot Instructions:"
          echo "1. Wait for Android boot menu"
          echo "2. Select 'Android-x86 9.0-r2'"
          echo "3. Choose 'Live CD - Run without installation'"
          echo " "

      - name: Keep Alive
        run: |
          echo "ðŸ”„ System running for 5.8 hours..."
          # Giá»¯ há»‡ thá»‘ng sá»‘ng
          sleep 20880
