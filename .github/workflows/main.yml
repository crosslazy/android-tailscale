name: Android 

on: 
  workflow_dispatch:
 
jobs:
  android:
    runs-on: ubuntu-22.04
    timeout-minutes: 350
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Getting Updates and Installing Packages
        run: |
          sudo apt update -y
          sudo apt install wget lxde qemu-kvm websockify novnc tigervnc-standalone-server -y
          sudo mkdir -p /root/.vnc
          sudo wget -O /root/.vnc/xstartup https://raw.githubusercontent.com/Efebey2903/android-tailscale/main/xstartup
          sudo chmod +x /root/.vnc/xstartup
          sudo curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey=tskey-auth-xxxxxxxxx --ssh

      - name: Download Android x86 64-bit ISO
        run: |
          echo "üîÑ T·∫£i Android-x86 64-bit (9.0-r2-k49)..."
          sudo aria2c -s16 -x16 -o android.iso "https://www.fosshub.com/Android-x86.html?dwl=android-x86_64-9.0-r2-k49.iso#"
          
          # Ki·ªÉm tra file
          if [ -f android.iso ]; then
            echo "‚úÖ Download th√†nh c√¥ng!"
            ls -lh android.iso
          else
            echo "‚ùå Download th·∫•t b·∫°i!"
            exit 1
          fi

      - name: Create Virtual Disk
        run: |
          sudo mkdir -p /mnt
          # T·∫°o disk 25GB cho Android
          sudo qemu-img create -f qcow2 /mnt/android_disk.qcow2 25G
          echo "‚úÖ ƒê√£ t·∫°o virtual disk 25GB"

      - name: Setup VNC
        run: |
          sudo pkill Xtigervnc || true
          sleep 2
          sudo vncserver -geometry 1024x768 -SecurityTypes None -rfbport 5900 :0
          sleep 3
          websockify --web /usr/share/novnc/ 6080 localhost:5900 &
          sleep 3

      - name: Start Android VM with Proper Boot
        run: |
          echo "üöÄ Kh·ªüi ƒë·ªông Android VM v·ªõi c·∫•u h√¨nh boot ƒë·∫∑c bi·ªát..."
          
          sudo qemu-system-x86_64 \
            -machine q35 \
            -m 4G \
            -cpu host \
            -smp cores=2 \
            -drive file=/mnt/android_disk.qcow2,if=virtio,format=qcow2 \
            -cdrom android.iso \
            -device virtio-vga \
            -vnc :0 \
            -usb \
            -device usb-tablet \
            -netdev user,id=net0,hostfwd=tcp::5555-:5555 \
            -device virtio-net-pci,netdev=net0 \
            -accel kvm \
            -boot d \
            -no-reboot \
            -serial stdio &
          
          echo "‚è≥ ƒê·ª£i Android boot... (2 ph√∫t)"
          sleep 120

      - name: Display Instructions
        run: |
          echo " "
          echo "üéâ ANDROID-X86 ƒêANG KH·ªûI ƒê·ªòNG!"
          echo "================================"
          echo "üåê Truy c·∫≠p: http://localhost:6080/vnc.html"
          echo "üîå VNC: localhost:5900" 
          echo "üì± ADB: localhost:5555"
          echo " "
          echo "üìã KHI TH·∫§Y M√ÄN H√åNH BOOT:"
          echo "1. Ch·ªçn d√≤ng ƒë·∫ßu: 'Android-x86 9.0-r2'"
          echo "2. Ho·∫∑c ch·ªçn: 'Advanced options' ‚Üí 'Android-x86 9.0-r2 (debug mode)'"
          echo "3. Ch·ªù h·ªá th·ªëng boot v√†o Android"
          echo "4. N·∫øu h·ªèi c√†i ƒë·∫∑t, ch·ªçn 'Live CD - Run without installation'"
          echo "5. Ho·∫∑c c√†i ƒë·∫∑t v√†o disk n·∫øu mu·ªën d√πng l√¢u d√†i"
          echo " "
          echo "‚ö° Th√¥ng tin phi√™n b·∫£n:"
          echo "- Android-x86 9.0-r2-k49 (64-bit)"
          echo "- Kernel 4.9"
          echo "- Size: 919MB"
          echo " "

      - name: Keep Alive
        run: |
          sleep 20880
