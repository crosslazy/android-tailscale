name: Android VM

on: 
  workflow_dispatch:
 
jobs:
  android:
    runs-on: ubuntu-22.04
    timeout-minutes: 350
    
    steps:
      - name: Setup Environment
        run: |
          sudo apt update -y
          sudo apt install wget qemu-kvm websockify novnc tigervnc-standalone-server -y
          sudo curl -fsSL https://tailscale.com/install.sh | sh

      - name: Download Android
        run: |
          sudo aria2c -s16 -x16 -o android.iso "https://www.fosshub.com/Android-x86.html?dwl=android-x86_64-9.0-r2-k49.iso#"

      - name: Start VNC Services
        run: |
          sudo vncserver -geometry 1024x768 -SecurityTypes None :1
          websockify --web /usr/share/novnc/ 6080 localhost:5901 &
          sleep 5

      - name: Start Android VM
        run: |
          sudo qemu-system-x86_64 \
            -machine q35 -m 4G -cpu host -smp 2 \
            -drive file=/mnt/a.img,if=virtio,format=raw \
            -cdrom android.iso \
            -device virtio-vga -vnc :1 \
            -usb -device usb-tablet \
            -netdev user,id=net0,hostfwd=tcp::5555-:5555 \
            -device virtio-net-pci,netdev=net0 \
            -accel kvm -boot d &

      - name: Keep Alive
        run: |
          echo "âœ… Há»‡ thá»‘ng Ä‘Ã£ sáºµn sÃ ng!"
          echo "ðŸ”— URL: http://localhost:6080/vnc.html"
          # Giá»¯ workflow cháº¡y
          sleep 21000
