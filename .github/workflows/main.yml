name: Android

on:
  workflow_dispatch:

jobs:
  android:
    runs-on: ubuntu-22.04

    steps:
      - name: Install Dependencies (QEMU, noVNC, Expect, Tailscale)
        run: |
          sudo apt update -y
          sudo apt install -y aria2 wget curl lxde qemu-kvm qemu-utils websockify novnc tigervnc-standalone-server expect
          sudo mkdir -p /root/.vnc
          sudo wget -O /root/.vnc/xstartup https://raw.githubusercontent.com/Efebey2903/android-tailscale/main/xstartup
          sudo chmod +x /root/.vnc/xstartup
          sudo curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --ssh

      - name: Download Android-x86 ISO & Create Virtual Disk
        run: |
          # Báº£n Android-x86 9.0-r2-k49 (64-bit)
          sudo aria2c -s16 -x16 -o android.iso https://www.fosshub.com/Android-x86.html?dwl=android-x86_64-9.0-r2-k49.iso#
          # Táº¡o á»• Ä‘Ä©a áº£o Ä‘á»ƒ cÃ i Android vÃ o
          sudo qemu-img create -f qcow2 /mnt/android_disk.qcow2 70G

      - name: Auto Install Android-x86 via QEMU
        run: |
          # Khá»Ÿi cháº¡y QEMU headless + auto cÃ i báº±ng expect
          cat > /tmp/install-android.expect <<'EOF'
          #!/usr/bin/expect -f
          set timeout 3000
          spawn sudo qemu-system-x86_64 -m 4096 -smp 2 \
            -boot d -cdrom android.iso -hda /mnt/android_disk.qcow2 \
            -vga virtio -nographic -enable-kvm

          # Ä‘á»£i menu khá»Ÿi Ä‘á»™ng ISO
          expect {
            "Live CD - Run Android-x86 without installation" { send "\033[B\r" }  # xuá»‘ng "Installation"
            "Installation" { send "\r" }
          }

          # Ä‘á»£i menu phÃ¢n vÃ¹ng
          expect "Select * Create/Modify partitions" { send "\r" }
          sleep 5

          # táº¡o phÃ¢n vÃ¹ng má»›i
          send "c\r"
          send "n\r"
          send "p\r"
          send "\r"
          send "\r"
          send "w\r"
          sleep 3

          # chá»n phÃ¢n vÃ¹ng vá»«a táº¡o
          expect "Select partition to install Android-x86" { send "\r" }
          sleep 3

          # Ä‘á»‹nh dáº¡ng ext4
          expect "Choose filesystem to format" { send "\033[B\033[B\r" }
          sleep 3

          # xÃ¡c nháº­n format
          expect "Do you want to format" { send "yes\r" }
          sleep 3

          # chá»n cÃ i GRUB
          expect "Do you want to install boot loader GRUB" { send "yes\r" }
          sleep 3

          # xÃ¡c nháº­n make system directory writable
          expect "Do you want to make system directory writable" { send "yes\r" }

          # Ä‘á»£i hoÃ n táº¥t
          expect "Installation finished" { send "\r" }
          sleep 10
          send "\r"
          EOF

          chmod +x /tmp/install-android.expect
          /tmp/install-android.expect

      - name: Launch Installed Android-x86 with VNC/noVNC
        run: |
          # Cháº¡y noVNC server Ä‘á»ƒ xem Android
          websockify --web /usr/share/novnc/ --wrap-mode=ignore 6080 localhost:5900 &
          sleep 3
          sudo vncserver -SecurityTypes None &

          # Boot Android tá»« á»• Ä‘Ä©a (Ä‘Ã£ cÃ i)
          sudo qemu-system-x86_64 \
            -m 4096 \
            -smp 2 \
            -boot c \
            -hda /mnt/android_disk.qcow2 \
            -vga virtio \
            -display vnc=:0 \
            -enable-kvm &

          echo "âœ… Android-x86 Ä‘Ã£ cÃ i xong vÃ  Ä‘ang cháº¡y!"
          echo "ðŸŒ Má»Ÿ VNC web táº¡i: http://localhost:6080/vnc.html"
          sleep infinity
