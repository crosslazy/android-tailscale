name: Android-x86 + Tailscale (Headless QEMU)

on:
  workflow_dispatch:

jobs:
  run-android:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y qemu-system-x86 aria2 expect tailscale

      - name: Start Tailscale
        run: |
          sudo systemctl enable --now tailscaled
          sudo tailscale up --authkey=${{ secrets.TS_KEY }} --hostname=android-x86
          sudo tailscale status

      - name: Download Android-x86 ISO & Create Disk
        run: |
          # Tạo thư mục mount
          sudo mkdir -p /mnt

          # Tải file ISO (mirror chính thức, tốc độ cao)
          sudo aria2c -s16 -x16 -d /mnt -o android.iso \
            "https://www.fosshub.com/Android-x86.html?dwl=android-x86_64-9.0-r2-k49.iso#"

          # Kiểm tra ISO tồn tại
          ls -lh /mnt/android.iso

          # Tạo ổ cứng ảo
          sudo qemu-img create -f qcow2 /mnt/android_disk.qcow2 70G
          ls -lh /mnt/android_disk.qcow2

      - name: Auto-install Android-x86 in QEMU (Headless)
        run: |
          # Tạo script expect để tự động cài đặt Android
          cat > /mnt/install-android.exp <<'EOF'
          #!/usr/bin/expect -f
          set timeout -1
          spawn sudo qemu-system-x86_64 \
            -m 4096 -smp 2 \
            -boot d \
            -cdrom /mnt/android.iso \
            -hda /mnt/android_disk.qcow2 \
            -vga virtio \
            -nographic \
            -enable-kvm

          expect {
            "Android-x86 Live & Installation CD" {
              send -- "\033\[B"       ;# Chọn "Installation"
              send -- "\r"
            }
          }
          interact
          EOF

          sudo chmod +x /mnt/install-android.exp
          sudo /mnt/install-android.exp

      - name: Done
        run: echo "✅ Android-x86 installed successfully and running via QEMU headless!"
