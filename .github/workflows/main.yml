name: Android QEMU (4 Cores, 12GB RAM, 400GB Disk)

on: 
  workflow_dispatch:

jobs:
  android:
    runs-on: ubuntu-22.04
    timeout-minutes: 450
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Getting Updates and Installing Packages
        run: |
          echo "ğŸ› ï¸ CÃ i Ä‘áº·t cÃ¡c gÃ³i cáº§n thiáº¿t..."
          sudo apt update -y
          sudo apt install wget lxde qemu-kvm websockify novnc tigervnc-standalone-server -y
          
          sudo mkdir -p /root/.vnc
          sudo wget -O /root/.vnc/xstartup https://raw.githubusercontent.com/Efebey2903/android-tailscale/main/xstartup
          sudo chmod +x /root/.vnc/xstartup

      - name: Download vÃ  Táº¡o á»” ÄÄ©a 400GB
        run: |
          echo "ğŸ”„ Táº£i Android image gá»‘c..."
          sudo wget -O android_base.img "https://github.com/back2root/android-x86-releases/releases/download/9.0-r2/android-x86_64-9.0-r2.img"

          echo "ğŸ“ Má»Ÿ rá»™ng á»• Ä‘Ä©a lÃªn 400GB..."
          sudo qemu-img convert -O qcow2 android_base.img android.qcow2
          sudo qemu-img resize android.qcow2 400G
          sudo mv android.qcow2 android.img

      - name: Setup VNC
        run: |
          echo "ğŸ–¥ï¸ Thiáº¿t láº­p mÃ´i trÆ°á»ng VNC/NoVNC..."
          sudo pkill Xtigervnc || true
          sleep 2
          sudo vncserver -geometry 1024x768 -SecurityTypes None -rfbport 5900 :0
          sleep 3
          websockify --web /usr/share/novnc/ 6080 localhost:5900 &
          sleep 3

      - name: Run Android from Image
        run: |
          echo "ğŸš€ Báº¯t Ä‘áº§u boot Android vá»›i Cáº¥u hÃ¬nh cao..."
          
          sudo qemu-system-x86_64 \
            -machine q35 \
            -m 12G \
            -cpu host \
            -smp cores=4 \
            -drive file=android.img,if=virtio,format=qcow2 \
            -device virtio-vga \
            -vnc :0 \
            -usb \
            -device usb-tablet \
            -netdev user,id=net0,hostfwd=tcp::5555-:5555 \
            -device virtio-net-pci,netdev=net0 \
            -accel kvm &
          
          echo "â³ Chá» Android khá»Ÿi Ä‘á»™ng... (90 giÃ¢y)"
          sleep 90

      - name: Display Connection Info
        run: |
          echo " "
          echo "ğŸ‰ ANDROID ÄANG CHáº Y! (4 Cores, 12GB RAM, 400GB Disk)"
          echo "====================="
          echo "ğŸŒ Truy cáº­p Web VNC (NoVNC): http://localhost:6080/vnc.html"
          echo "ğŸ”Œ VNC Client: localhost:5900"
          echo "ğŸ“± ADB Debugging: localhost:5555"
          echo " "
          
      - name: Keep Alive
        run: |
          sleep 20880
