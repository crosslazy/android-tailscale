name: Android Remote

on: 
  workflow_dispatch:
 
jobs:
  android:
    runs-on: ubuntu-22.04
    timeout-minutes: 350
    
    steps:
      - name: Setup Environment
        run: |
          sudo apt update -y
          sudo apt install wget qemu-kvm websockify novnc tigervnc-standalone-server curl -y

      - name: Install and Setup Tailscale (No Auth Key)
        run: |
          # CÃ i Ä‘áº·t Tailscale
          curl -fsSL https://tailscale.com/install.sh | sh
          
          # Khá»Ÿi Ä‘á»™ng Tailscale khÃ´ng cáº§n auth key (dÃ¹ng magic DNS)
          echo "ðŸš€ Starting Tailscale without auth key..."
          sudo tailscale up --accept-routes --ssh --accept-dns
          
          # Äá»£i káº¿t ná»‘i
          sleep 10
          
          # Hiá»ƒn thá»‹ thÃ´ng tin káº¿t ná»‘i
          echo "ðŸ”— Tailscale connection info:"
          tailscale status
          tailscale ip -4
          tailscale ip -6
          
          # Láº¥y MagicDNS hostname
          echo "ðŸŒ MagicDNS hostname:"
          tailscale status --json | jq -r '.Self.DNSName' || echo "ChÆ°a cÃ³ MagicDNS, dÃ¹ng IP trá»±c tiáº¿p"

      - name: Download Android
        run: |
          sudo aria2c -s16 -x16 -o android.iso "https://www.fosshub.com/Android-x86.html?dwl=android-x86_64-9.0-r2-k49.iso#"

      - name: Create Virtual Disk
        run: |
          sudo mkdir -p /mnt
          sudo qemu-img create -f qcow2 /mnt/android.qcow2 20G

      - name: Start VNC Services
        run: |
          # Khá»Ÿi Ä‘á»™ng VNC
          sudo vncserver -geometry 1024x768 -SecurityTypes None :1
          sleep 3
          
          # Khá»Ÿi Ä‘á»™ng NoVNC
          websockify --web /usr/share/novnc/ 6080 localhost:5901 &
          sleep 3

      - name: Start Android VM
        run: |
          sudo qemu-system-x86_64 \
            -machine q35 \
            -m 3G \
            -cpu host \
            -smp cores=2 \
            -drive file=/mnt/android.qcow2,if=virtio,format=qcow2 \
            -cdrom android.iso \
            -device virtio-vga \
            -vnc :1 \
            -usb \
            -device usb-tablet \
            -netdev user,id=net0,hostfwd=tcp::5555-:5555 \
            -device virtio-net-pci,netdev=net0 \
            -accel kvm \
            -boot d &
          
          echo "â³ Äá»£i Android boot... (60 giÃ¢y)"
          sleep 60

      - name: Display Connection Info
        run: |
          # Láº¥y thÃ´ng tin káº¿t ná»‘i
          TAILSCALE_IP=$(tailscale ip -4)
          HOSTNAME=$(hostname)
          
          echo " "
          echo "ðŸŽ‰ ANDROID REMOTE READY!"
          echo "========================"
          echo "ðŸŒ CONNECTION METHODS:"
          echo " "
          echo "1ï¸âƒ£ **Method 1 - MagicDNS (Recommended):**"
          echo "   Web VNC: http://$HOSTNAME.tailscale:6080/vnc.html"
          echo "   VNC Direct: $HOSTNAME.tailscale:5901" 
          echo "   ADB: $HOSTNAME.tailscale:5555"
          echo " "
          echo "2ï¸âƒ£ **Method 2 - Direct IP:**"
          echo "   Web VNC: http://$TAILSCALE_IP:6080/vnc.html"
          echo "   VNC Direct: $TAILSCALE_IP:5901"
          echo "   ADB: $TAILSCALE_IP:5555"
          echo " "
          echo "3ï¸âƒ£ **Method 3 - Local Access:**"
          echo "   Web VNC: http://localhost:6080/vnc.html"
          echo "   VNC: localhost:5901"
          echo "   ADB: localhost:5555"
          echo " "
          echo "ðŸ“± **HOW TO CONNECT REMOTELY:**"
          echo "1. CÃ i Tailscale app trÃªn device cá»§a báº¡n"
          echo "2. Login báº±ng cÃ¹ng tÃ i khoáº£n GitHub"
          echo "3. Truy cáº­p URL trÃªn tá»« device Ä‘Ã³"
          echo " "
          echo "ðŸ”— **Tailscale Status:**"
          tailscale status
          echo " "

      - name: Keep Alive
        run: |
          echo "ðŸ”„ System is running for 5.8 hours..."
          echo "ðŸ“Š Active services monitoring:"
          
          # Giá»¯ workflow cháº¡y + hiá»ƒn thá»‹ status
          for i in {1..208}; do  # 208 intervals of 60 seconds = 20880 seconds
            echo "$(date): âœ… System alive - Tailscale: $(tailscale status --json | jq -r '.BackendState' 2>/dev/null || echo 'unknown')"
            sleep 60
          done
