name: Android-x86 + Auto Install + Tailscale

on:
  workflow_dispatch:

jobs:
  android:
    runs-on: ubuntu-latest

    steps:
      - name: Cập nhật hệ thống và cài công cụ cần thiết
        run: |
          sudo apt update -y
          sudo apt install -y qemu-system-x86 expect aria2 curl gnupg

      - name: Cài đặt Tailscale (fix cho Ubuntu 24.04 Noble)
        run: |
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.tailscale-keyring.list | sudo tee /etc/apt/sources.list.d/tailscale.list >/dev/null
          sudo apt update
          sudo apt install -y tailscale
          sudo systemctl enable --now tailscaled
          sudo tailscale up --authkey=${{ secrets.TS_KEY }} --hostname=android-x86

      - name: Tải ISO Android-x86 9.0 r2 (k49)
        run: |
          sudo mkdir -p /mnt/android
          sudo aria2c -s16 -x16 -d /mnt/android -o android.iso \
            "https://www.fosshub.com/Android-x86.html?dwl=android-x86_64-9.0-r2-k49.iso#"
          ls -lh /mnt/android/android.iso

      - name: Tạo ổ đĩa ảo cho Android
        run: |
          sudo qemu-img create -f qcow2 /mnt/android/android_disk.qcow2 70G
          ls -lh /mnt/android/android_disk.qcow2

      - name: Cài đặt Android-x86 tự động (không GUI)
        run: |
          cat > /mnt/android/auto_install.exp <<'EOF'
          #!/usr/bin/expect -f
          set timeout -1
          spawn sudo qemu-system-x86_64 \
            -m 4096 -smp 2 \
            -cdrom /mnt/android/android.iso \
            -hda /mnt/android/android_disk.qcow2 \
            -boot d \
            -vga virtio \
            -enable-kvm \
            -nographic

          expect {
            "Android-x86 Live & Installation CD" {
              send -- "\033\[B"   ;# Xuống dòng chọn Installation
              send -- "\r"
            }
          }

          # Đợi menu phân vùng
          expect "Create/Modify partitions"
          send -- "\r"

          # Tạo phân vùng mới
          expect "Command"
          send -- "n\r"
          expect "Select"
          send -- "p\r"
          expect "Partition number"
          send -- "1\r"
          expect "First sector"
          send -- "\r"
          expect "Last sector"
          send -- "\r"
          expect "Command"
          send -- "w\r"

          # Xác nhận ghi thay đổi
          expect "Syncing disks"
          sleep 2
          send -- "\r"

          # Format phân vùng ext4
          expect "Choose partition"
          send -- "\r"
          expect "Do you want to format"
          send -- "yes\r"
          expect "Select file system"
          send -- "ext4\r"

          # Cài bootloader GRUB
          expect "Do you want to install boot loader GRUB"
          send -- "yes\r"
          expect "Do you want to install /system directory as read-write"
          send -- "yes\r"

          sleep 5
          send -- "\r"
          interact
          EOF

          sudo chmod +x /mnt/android/auto_install.exp
          sudo /mnt/android/auto_install.exp

      - name: Khởi động Android sau khi cài đặt
        run: |
          sudo qemu-system-x86_64 \
            -m 4096 -smp 2 \
            -hda /mnt/android/android_disk.qcow2 \
            -boot c \
            -vga virtio \
            -enable-kvm \
            -nographic
