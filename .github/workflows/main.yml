name: Android

on:
  workflow_dispatch:

jobs:
  android:
    runs-on: ubuntu-22.04

    steps:
      - name: Install Dependencies
        run: |
          sudo apt update -y
          sudo apt install -y aria2 wget curl qemu-kvm qemu-utils expect lxde novnc websockify tigervnc-standalone-server
          sudo mkdir -p /root/.vnc
          sudo wget -O /root/.vnc/xstartup https://raw.githubusercontent.com/Efebey2903/android-tailscale/main/xstartup
          sudo chmod +x /root/.vnc/xstartup
          sudo curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --ssh

      - name: Download Android-x86 ISO & Create Disk
        run: |
          # Táº£i file ISO (mirror OSDN há»£p lá»‡)
          sudo aria2c -s16 -x16 -o /mnt/android.iso https://www.fosshub.com/Android-x86.html?dwl=android-x86_64-9.0-r2-k49.iso#

          # Kiá»ƒm tra ISO tá»“n táº¡i
          ls -lh /mnt/android.iso

          # Táº¡o á»• cá»©ng áº£o Ä‘á»ƒ cÃ i Android
          sudo qemu-img create -f qcow2 /mnt/android_disk.qcow2 70G
          ls -lh /mnt/android_disk.qcow2

      - name: Auto Install Android-x86 with Expect
        run: |
          cat > /tmp/install-android.expect <<'EOF'
          #!/usr/bin/expect -f
          set timeout 3000
          spawn sudo qemu-system-x86_64 -m 4096 -smp 2 \
            -boot d -cdrom /mnt/android.iso -hda /mnt/android_disk.qcow2 \
            -vga virtio -nographic -enable-kvm

          # Ä‘á»£i menu khá»Ÿi Ä‘á»™ng ISO
          expect {
            "Live CD - Run Android-x86 without installation" { send "\033[B\r" }
            "Installation" { send "\r" }
          }
          sleep 5
          send "\r"
          sleep 120
          EOF

          chmod +x /tmp/install-android.expect
          /tmp/install-android.expect

      - name: Launch Installed Android-x86 with VNC/noVNC
        run: |
          websockify --web /usr/share/novnc/ --wrap-mode=ignore 6080 localhost:5900 &
          sleep 3
          sudo vncserver -SecurityTypes None &

          sudo qemu-system-x86_64 \
            -m 4096 \
            -smp 2 \
            -boot c \
            -hda /mnt/android_disk.qcow2 \
            -vga virtio \
            -display vnc=:0 \
            -enable-kvm &

          echo "âœ… Android-x86 Ä‘ang cháº¡y!"
          echo "ðŸŒ Má»Ÿ http://localhost:6080/vnc.html Ä‘á»ƒ xem giao diá»‡n"
          sleep infinity
